\mychapter{Program Overview --- The Fundamental Concepts}
\label{chap:overview}

Fusion power plants are complex systems consisting of many non-linear
interactions. One method that can be used to model this kind of system is to
iterate a number of free parameters (the so-called \textit{iteration
  variables} --- see Section~\ref{sec:itvars}) in a controlled way so as to
find a self-consistent set of device parameters that satisfy all of the
system's \textit{constraint equations} --- see
Section~\ref{sec:constraints}. \process\ is organised in a standard equation
solver format to enable this task to be performed efficiently. The physics and
engineering routines together serve as a \textit{function evaluator},
providing the information used in the solution of the constraints. The
numerical modules present in \process\ perform the iteration required, and
also incorporate the option to maximise or minimise a given \textit{figure of
  merit} -- see Section~\ref{sec:foms}.

\section{Equation Solvers}

\process\ contains two non-linear equation solver packages, which reflect the
two major modes of operation available. Each of these has its own uses, as is
now discussed.

\subsection{Non-optimisation mode}

The first of the two equation solvers present in \process\ is the
non-optimisation package HYBRD~\cite{hybrd_anl,hybrd}. Formally, HYBRD
finds a zero of a system of $N$ non-linear functions in $N$ variables. This
means simply that $N$ variables (power plant parameters) are iterated by
\process\ in such a way as to solve a set of $N$ equations (physics or
engineering laws), i.e.\ a set of self-consistent power plant parameters is
found. This is useful for performing benchmark comparisons, when the device
size is kept fixed, and one only wishes to find calculated stresses, beta
values, fusion powers, etc. A flow diagram of \process\ in non-optimisation
mode is shown in Figure~\ref{fig:flow_hybrd}.

% Flow diagram for HYBRD run

\setlength{\unitlength}{1mm}

\begin{figure}[tbph]
\begin{center}

\begin{picture}(140.0,140.0)(0.0,60.0)

\put(50.0,197.0){\makebox(0,0){initialise variables}}
\put(50.0,185.0){\makebox(0,0){input from file}}
\put(50.0,173.0){\makebox(0,0){define free parameters}}
\put(50.0,161.0){\makebox(0,0){define rules}}
\put(50.0,155.0){\makebox(0,0){to be obeyed}}
\put(50.0,137.0){\makebox(0,0){evaluate physics, engineering}}
\put(50.0,131.0){\makebox(0,0){and cost functions}}
\put(50.0,119.0){\makebox(0,0){apply consistency equations}}
\put(50.0,77.0){\makebox(0,0){write output}}
\put(110.0,125.0){\makebox(0,0){iterate}}
\put(110.0,119.0){\makebox(0,0){free parameters}}

\thicklines

\put(30.0,194.0){\framebox(40.0,6.0){}}
\put(34.0,182.0){\framebox(32.0,6.0){}}
\put(28.0,170.0){\framebox(44.0,6.0){}}
\put(34.0,152.0){\framebox(32.0,12.0){}}
\put(22.0,128.0){\framebox(56.0,12.0){}}
\put(22.0,116.0){\framebox(56.0,6.0){}}
\put(34.0,74.0){\framebox(32.0,6.0){}}
\put(94.0,116.0){\framebox(32.0,12.0){}}

\put(50.0,98.0){\makebox(0,0){self-consistent?}}
\put(50.0,86.0){\line(-2,1){24.0}}
\put(26.0,98.0){\line(2,1){24.0}}
\put(50.0,110.0){\line(2,-1){24.0}}
\put(74.0,98.0){\line(-2,-1){24.0}}

\put(44.0,82.0){yes}
\put(78.0,100.0){no}

\put(50.0,194.0){\vector(0,-1){6.0}}
\put(50.0,182.0){\vector(0,-1){6.0}}
\put(50.0,170.0){\vector(0,-1){6.0}}
\put(50.0,152.0){\vector(0,-1){12.0}}
\put(50.0,128.0){\vector(0,-1){6.0}}
\put(50.0,116.0){\vector(0,-1){6.0}}
\put(50.0,86.0){\vector(0,-1){6.0}}
\put(74.0,98.0){\vector(1,0){18.0}}
\put(110.0,98.0){\vector(0,1){9.0}}
\put(110.0,128.0){\vector(0,1){9.0}}
\put(110.0,146.0){\vector(-1,0){30.0}}

\put(92.0,98.0){\line(1,0){18.0}}
\put(110.0,107.0){\line(0,1){9.0}}
\put(110.0,137.0){\line(0,1){9.0}}
\put(80.0,146.0){\line(-1,0){30.0}}

\thinlines
\end{picture}

\end{center}
\caption[Flow diagram of \process\ in non-optimisation mode]
{\label{fig:flow_hybrd}
  \textit{Flow diagram of \process\ in non-optimisation mode.}
}
\end{figure}

\subsection{Optimisation mode}

%\author{H. Lux}%

Sometimes one wants to find an optimal machine that is both consistent with
the physics and engineering constraints but also minimises or maximises a
certain \textit{figure of merit}. This requires running \process\/ in
optimisation mode. For these applications \process\/ uses the routine \vmcon\/
\cite{vmcon} based on a variable metric method for constrained optimisation by
Powell \cite{Powell1978}. It finds a stationary point of an objective
function/figure of merit consistent with a set of equality and inequality
constraints (c.f. section \ref{sec:GNPP}). It is designed to solve the
necessary but not sufficient conditions of a constrained optimum, hence, the
solution does not have to be a global optimum (c.f. \ref{sec:Lagrange}).

The detailed algorithm is explained in Appendix~\ref{app:Opt} and is based on
the Lagrange method (c.f. section \ref{sec:Lagrange}) that combines both the
objective function and the constraints using Lagrange multipliers. It applies
a sequential quadratic programming approach (c.f. section \ref{sec:SQP}) in
which a series of subproblems is solved that constitute a local quadratic
expansion of the Lagrangian (c.f. section \ref{sec:QSP}). The solution of the
quadratic subproblem is the direction of a line search along which a one
dimensional optimisation is performed (c.f. section
\ref{sec:linesearch}). This line search was introduced by Powell to assure
convergence from bad starting parameters. Within \process\/ we have modified
the line search of the original \vmcon\/ routine to assure convergence, even
for slightly inconsistent input functions.

The algorithm uses a quasi-Newtonian approach which only requires continuous
first derivatives of these functions. While the first derivatives are
evaluated using a finite difference approximation, the second derivatives are
estimated using a variant of the Broyden-Fletcher-Goldfarb-Shanno update
(c.f. section \ref{sec:BFGS}).

The convergence criterium of the solver as well as the detailed interpretation
of the various error codes are explained in section \ref{sec:vmcon}. A flow
diagram of \process\/ in optimisation mode is shown in Figure
\ref{fig:flow_vmcon}.

% Flow diagram for VMCON run

\setlength{\unitlength}{1mm}

\begin{figure}[tbph]
\begin{center}

\begin{picture}(140.0,200.0)

\put(50.0,197.0){\makebox(0,0){initialise variables}}
\put(50.0,185.0){\makebox(0,0){input from file}}
\put(50.0,173.0){\makebox(0,0){define free parameters}}
\put(50.0,161.0){\makebox(0,0){define rules}}
\put(50.0,155.0){\makebox(0,0){to be obeyed}}
\put(50.0,143.0){\makebox(0,0){define performance}}
\put(50.0,137.0){\makebox(0,0){requirements}}
\put(50.0,125.0){\makebox(0,0){define figure-of-merit}}
\put(50.0,107.0){\makebox(0,0){evaluate physics, engineering}}
\put(50.0,101.0){\makebox(0,0){and cost functions}}
\put(50.0,89.0){\makebox(0,0){apply consistency equations}}
\put(50.0,83.0){\makebox(0,0){and limit equations}}
\put(50.0,11.0){\makebox(0,0){write output}}
\put(110.0,92.0){\makebox(0,0){iterate}}
\put(110.0,86.0){\makebox(0,0){free parameters}}

\thicklines

\put(30.0,194.0){\framebox(40.0,6.0){}}
\put(34.0,182.0){\framebox(32.0,6.0){}}
\put(28.0,170.0){\framebox(44.0,6.0){}}
\put(34.0,152.0){\framebox(32.0,12.0){}}
\put(30.0,134.0){\framebox(40.0,12.0){}}
\put(28.0,122.0){\framebox(44.0,6.0){}}
\put(22.0,98.0){\framebox(56.0,12.0){}}
\put(22.0,80.0){\framebox(56.0,12.0){}}
\put(34.0,8.0){\framebox(32.0,6.0){}}
\put(94.0,83.0){\framebox(32.0,12.0){}}

\put(50.0,62.0){\makebox(0,0){self-consistent?}}
\put(50.0,50.0){\line(-2,1){24.0}}
\put(26.0,62.0){\line(2,1){24.0}}
\put(50.0,74.0){\line(2,-1){24.0}}
\put(74.0,62.0){\line(-2,-1){24.0}}

\put(44.0,46.0){yes}
\put(78.0,64.0){no}

\put(50.0,32.0){\makebox(0,0){F-o-M minimised?}}
\put(50.0,20.0){\line(-2,1){24.0}}
\put(26.0,32.0){\line(2,1){24.0}}
\put(50.0,44.0){\line(2,-1){24.0}}
\put(74.0,32.0){\line(-2,-1){24.0}}

\put(44.0,16.0){yes}
\put(78.0,34.0){no}

\put(50.0,194.0){\vector(0,-1){6.0}}
\put(50.0,182.0){\vector(0,-1){6.0}}
\put(50.0,170.0){\vector(0,-1){6.0}}
\put(50.0,152.0){\vector(0,-1){6.0}}
\put(50.0,134.0){\vector(0,-1){6.0}}
\put(50.0,122.0){\vector(0,-1){12.0}}
\put(50.0,98.0){\vector(0,-1){6.0}}
\put(50.0,80.0){\vector(0,-1){6.0}}
\put(50.0,50.0){\vector(0,-1){6.0}}
\put(50.0,20.0){\vector(0,-1){6.0}}
\put(74.0,62.0){\vector(1,0){18.0}}
\put(74.0,32.0){\vector(1,0){18.0}}
\put(110.0,62.0){\vector(0,1){10.5}}
\put(110.0,32.0){\vector(0,1){15.0}}
\put(110.0,95.0){\vector(0,1){10.5}}
\put(110.0,116.0){\vector(-1,0){30.0}}

\put(92.0,62.0){\line(1,0){18.0}}
\put(92.0,32.0){\line(1,0){18.0}}
\put(110.0,47.0){\line(0,1){15.0}}
\put(110.0,72.5){\line(0,1){10.5}}
\put(110.0,105.5){\line(0,1){10.5}}
\put(80.0,116.0){\line(-1,0){30.0}}

\thinlines
\end{picture}

\end{center}
\caption[Flow diagram of \process\ in optimisation mode]
{\label{fig:flow_vmcon} \textit{Conceptual flow diagram of \process\/ in
    optimisation mode. Please note that this is a simplistic interpretation of
    the actual sequence of operations, to outline the difference between
    non-optimisation and optimisation modes. For a more detailed (and
    correct!) \vmcon\ flow diagram, please see Figure~\ref{fig:vmconflow}.}  }
\end{figure}

\subsection{Scans}

It is often useful to be able to scan through a range of values of a given
parameter to see what effect this has on the machine as a whole.  Sensitivity
studies of this kind can be achieved very easily using \process. Scans are
carried out in optimisation mode, whereby the code performs initially a run
using the parameters specified in the input file, and then a series of runs
using the parameters produced at the end of the previous iteration. The value
of the quantity being scanned is specified at every stage --- see
Section~\ref{sec:scans}. This method ensures that a smooth variation in the
machine parameters is achieved.

\section{The Variable Descriptor File}
\label{sec:vardes}

The variable descriptor file \texttt{vardes.html} is an invaluable resource for
the user of \process. It acts as a dictionary / reference manual for the
code's variables, and contains the following information about each:
\begin{itemize}
\item name
\item dimensions (of arrays)
\item default value(s) of those variables that are not initially derived from
  a combination of other values. The default values are mostly set in the
  modules contained within source file \texttt{global\_variables.f90}.
\item description, including physical units if relevant
\item for switches/flags, the meanings of all allowed values
\item iteration variable number, if relevant
\item corresponding constraint equation, if relevant
\end{itemize}
In addition, global code parameters are labelled \texttt{FIX}. These can only
be changed by editing the relevant source file, but this should not be carried
out unless it is absolutely necessary.

All the variables that are shown with a default value are available to be
changed by the user using the input file (Section~\ref{sec:infile}), except
for those which are labelled \texttt{FIX}. Variables not shown with a default
value are calculated by the code from a combination of other parameters, and
so it would be meaningless to initialise them.  Obviously, these variables
cannot be changed using the input file.

The file is generated from specially-formatted comment lines within the source
code (see Section~\ref{sec:autodoc} for more details). Therefore, it is
exceedingly important to keep these comment lines relevant and in sync with
the variables they describe.

\section{Input Parameters}
\label{sec:inpars}

Input parameters make up a large proportion of the variables listed in the
variable descriptor file. They comprise all those variables that, once set in
the initialisation routine or redefined in the input file, do not change
throughout a \process\ run. In fact, only those variables defined as iteration
variables (Section~\ref{sec:itvars}) can change during the course of a run.

\section{Constraint Equations}
\label{sec:constraints}

Any computer program naturally contains myriads of equations. The built-in
equation solvers within \process\ act on a special class, known as
\textit{constraint equations}, all of which are formulated in routine
\texttt{CONSTRAINTS} in source file
\texttt{constraint\_equations.f90}. Table~\ref{tab:eqns} summarises the
constraint equations available in \process. These can be split into two types
--- (1) consistency equations, that enforce consistency between the physics
and engineering parameters, and (2) limit equations, that enforce various
parameters to lie within their allowed limits. The \texttt{neqns} constraint
equations that the user chooses for a given run are activated by including the
equation numbers in the first \texttt{neqns} elements of array \texttt{icc}.

\subsection{Consistency equations}

Consistency equations are usually \textit{equalities}\/ that ensure that the
machine produced by \process\ is self-consistent. This means, therefore, that
many of these constraint equations should \textit{always}\/ be used, namely
equations~1, 2, 10 and 11 (see Table~\ref{tab:eqns}).  Equation~7 should also
be activated if neutral beam injection is used.  The other consistency
equations can be activated if required.

A typical consistency equation ensures that two functions $g$ and $h$ are
equal:
\begin{eqnarray*}
g(x,y,z,\ldots) & = & h(x,y,z,\ldots) \\
c_i & = & 1 - \frac{g}{h}
\end{eqnarray*}
The equation solvers VMCON and HYBRD need the constraint equations $c_i$ to be
given in the form shown, since they adjust the iteration variables so as to
obtain $c_i = 0$, thereby ensuring that $g = h$.

\subsection{Limit equations}

The limit equations are usually \textit{inequalities}\/ that ensure that
various physics or engineering limits are not exceeded. Each of these
equations has an associated \textit{f-value}, which allow them to be coded as
equalities. The f-values are used as follows.

In general, limit equations have the form

\[ \mbox{\textit{calculated quantity}} = f \times \mbox{\textit{maximum allowable
value}} \]

where $f$ is the f-value. In optimisation mode, all iteration variables have
prescribed lower and upper bounds. If $f$ is chosen to be an iteration
variable and is given a lower bound of zero and an upper bound of one, then
the limit equation does indeed constrain the calculated quantity to lie
between zero and its maximum allowable value, as required.

As with the consistency equations, the general form of the limit equations is
\[ c_i = 1 - f.\frac{h_{\mbox{\scriptsize max}}}{h} \]
where $h_{\mbox{\scriptsize max}}$ is the maximum allowed value of the quantity $h$.

Sometimes, the limit equation and f-value are used to ensure that quantity $h$
is \textit{larger}\/ than its \textit{minimum}\/ value $h_{\mbox{\scriptsize min}}$. In
this case, $0 \leq f \leq 1$ (as before), but the equation takes the form
\[ c_i = 1 - f.\frac{h}{h_{\mbox{\scriptsize min}}} \]

By fixing the f-value (i.e.\ not including it in the \texttt{ixc} array), the
limit equations can be used as equality constraints. For example, to set the
net electric power to a certain value, the following should be carried out:
\begin{enumerate}
\item Activate constraint equation 16 by including it in the first
  \texttt{neqns} elements of array \texttt{icc}
\item Set \texttt{fpnetel = 1.0D0}
\item Ensure that \texttt{fpnetel} (iteration variable no.\ 25) \textit{DOES
    NOT}\/ appear in array \texttt{ixc}
\item Set \texttt{pnetelin} to the required net electric power.
\end{enumerate}

Limit equations are not restricted to optimisation mode. In non-optimisation
mode, the iteration variables are not bounded, but the f-values can still be
used to provide information about how calculated values compare with limiting
values, without having to change the characteristics of the device being
benchmarked to find a solution.

It is for this reason that all the constraint equations used in \process\ are
formulated as equalities, despite the fact that equation solver \vmcon\ can
solve for inequalities as well. The use of f-values precludes this need, and
allows the non-optimising equation solver HYBRD to use the same constraint
equations.

% NEW
\label{sec:slack}
% It is common practice to replace inequality constraints with equality
% constraints introducing so called slack variables $s$ \cite[e.g.]{Avriel2003},
% i.e.
% \begin{equation}
% c(\vec{x}) \geq 0 
% \end{equation}
% can be rewritten as 
% \begin{equation}
% c(\vec{x}) - s = 0 \textnormal{ with } s \geq 0.
% \end{equation}
% These slack variables then allow for easy distinction between 
% \begin{itemize}
% \item a {\it binding} or {\it active} constraint $s=0$,
% \item a {\it non-binding} or {\it non-active} constraint $s>0$,
% \item and an {\it infeasible} point $s<0$.
% \end{itemize}

% Note that as long as $s$ is an iteration variable this formulation is
% equivalent to solving the inequality constraints. This prescription has been
% used for all inequality constraints within \process\/ to both allow
% inequalities to be turn into equality constraints and for consistency with the
% non-optimisation solver.

% XXX Influence on performance? 

% XXX include test results from new version.

% XXX Comment on reduction of iteration variables and NVAR $>$ NEQNS. 



% Table summarising constraint equations

\begin{table}[tbph]
\footnotesize
\begin{center}

\begin{tabular}{||c|l|c|l||} \hline
\texttt{icc} &                                                  &      & corresponding \\
no. & description                                               & type & \texttt{ixc} variables \\ \hline
1   & plasma beta consistency                                   & C    & \textbf{5} \\
2   & global power balance                                      & C    & \textbf{10},1,2,3,4,6,11 \\
3   & ion power balance (DEPRECATED - DO NOT USE)               & C    & \textbf{10},1,2,3,4,6,11 \\
4   & electron power balance (DEPRECATED - DO NOT USE)          & C    & \textbf{10},1,2,3,4,6,11 \\
5   & density upper limit                                       & L    & \textbf{9},1,2,3,4,5,6 \\
6   & epsilon-beta poloidal upper limit                         & L    & \textbf{8},1,2,3,4,6 \\
7   & beam ion density (NBI)                                    & C    & \textbf{7} \\
8   & neutron wall load upper limit                             & L    & \textbf{14},1,2,3,4,6 \\
9   & fusion power upper limit                                  & L    & \textbf{26},1,2,3,4,6 \\
10  & toroidal field 1/R consistency                            & C    & \textbf{12},1,2,3,13 \\
11  & radial build consistency                                  & C    & \textbf{3},1,13,16,29,42,61 \\
12  & volt second capability lower limit                        & L    & \textbf{15},1,2,3 \\
13  & burn time lower limit (PULSE)                             & L    & \textbf{21},1,16,17,22,29,42,44,61 \\
14  & neutral beam decay lengths = \texttt{tbeamin} consistency (NBI) & C    & \textbf{19},1,2,3,6 \\
15  & L-H power threshold limit                                 & L    & \textbf{103} \\
16  & net electric power lower limit                            & L    & \textbf{25},1,2,3 \\
17  & radiation power upper limit                               & L    & \textbf{28} \\
18  & divertor heat load upper limit                            & L    & \textbf{27} \\
19  & MVA upper limit                                           & L    & \textbf{30} \\
20  & neutral beam tangency radius upper limit (NBI)            & L    & \textbf{33},31,3,13 \\
21  & minor radius lower limit                                  & L    & \textbf{32} \\
22  & divertor collisionality upper limit                       & L    & \textbf{34},43 \\
23  & conducting shell to plasma minor radius ratio upper limit & L    & \textbf{104},1,74 \\
24  & Beta upper limit (also beta limit in stellarators)        & L    & \textbf{36},1,2,3,4,6,18 \\
25  & peak toroidal field upper limit                           & L    & \textbf{35},3,13,29 \\
26  & central solenoid current density at End of Flat-top upper limit    & L    & \textbf{38},37,41,12 \\
27  & central solenoid current density at Beginning of Pulse upper limit & L    & \textbf{39},37,41,12 \\
28  & fusion gain $Q$ lower limit                               & L    & \textbf{45},47,40 \\
29  & inboard radial build = specified value                    & C    & \textbf{3},1,13,16,29,42,61 \\
30  & injection power upper limit                               & L    & \textbf{46},47,11 \\
31  & TF coil case stress upper limit (SCTF)                    & L    & \textbf{48},56,57,58,59,60,24 \\
32  & TF coil conduit stress upper limit (SCTF)                 & L    & \textbf{49},56,57,58,59,60,24 \\
33  & TF coil $I_{\mbox{\scriptsize operational}}/
I_{\mbox{\scriptsize critical}}$ upper limit (SCTF)                    & L    & \textbf{50},56,57,58,59,60,24 \\
34  & TF coil dump voltage upper limit (SCTF)                   & L    & \textbf{51},52,56,57,58,59,60,24 \\
35  & TF coil $J_{\mbox{\scriptsize winding pack}}/
J_{\mbox{\scriptsize protection}}$ upper limit (SCTF)                   & L    & \textbf{53},56,57,58,59,60,24 \\
36  & TF coil temperature margin lower limit (SCTF)             & L    & \textbf{54},55,56,57,58,59,60,24 \\
37  & current drive gamma upper limit                           & L    & \textbf{40},47 \\
38  & first wall coolant temperature rise upper limit (PULSE)   & L    & \textbf{62} \\
39  & first wall peak temperature upper limit (PULSE)           & L    & \textbf{63} \\
40  & injection power lower limit (PULSE)                       & L    & \textbf{64} \\
41  & central solenoid current ramp-up time lower limit (PULSE) & L    & \textbf{66},65 \\
42  & cycle time lower limit (PULSE)                            & L    & \textbf{67},65,17 \\
43  & average centrepost temperature (ST)                       & C    & \textbf{69},70,13 \\
44  & peak centrepost temperature upper limit (ST)              & L    & \textbf{68},69,70 \\
45  & edge safety factor lower limit    (ST)                    & L    & \textbf{71},1,2,3 \\
46  & Ip/Irod upper limit               (ST)                    & L    & \textbf{72},2,60 \\
47  & TF coil toroidal thickness upper limit (RFP)              & L    & \textbf{76},77,13,3 \\
48  & poloidal beta upper limit                                 & L    & \textbf{79},2,3,18 \\
49  & reversal parameter $< 0$ (RFP)                            & L    & \textbf{80},78,3,1 \\
50  & IFE repetition rate upper limit (IFE)                     & L    & \textbf{86} \\
\hline
\end{tabular}
\end{center}
\caption[List of constraint equations 1--50]
{\label{tab:eqns}
  \textit{Summary of the first 50 constraint equations present in \process. Consistency
    equations are marked C, limit equations are marked L\@. Some
    (non-exhaustive) iteration variable numbers (see Tables~\ref{tab:itvars1}
    and~\ref{tab:itvars2}) that directly affect the associated constraint
    equations are given, the one listed first being the most relevant.}
}
\normalsize
\end{table}

\begin{table}[tbph]
\footnotesize
\begin{center}

\begin{tabular}{||c|l|c|l||} \hline
\texttt{icc} &                                                  &      & corresponding \\
no. & description                                               & type & \texttt{ixc} variables \\ \hline
51  & startup volt-seconds consistency (PULSE)                  & C    & \textbf{16},29,3,1 \\
52  & tritium breeding ratio lower limit                        & L    & \textbf{89},90,91 \\
53  & peak neutron fluence on TF coil upper limit               & L    & \textbf{92},93,94 \\
54  & peak TF coil nuclear heating upper limit                  & L    & \textbf{95},93,94 \\
55  & final He concentration in vacuum vessel upper limit       & L    & \textbf{96},93,94 \\
56  & $P_{\mbox{\scriptsize separatrix}}/R_{\mbox{\scriptsize major}}$ upper limit & L    & \textbf{97},1,3 \\
57  & (OBSOLETE) TF coil outer leg toroidal thickness lower limit (SCTF)   & L    & \textbf{99},29,13  \\
58  & (OBSOLETE) TF coil outer leg radial thickness lower limit (SCTF)     & L    & \textbf{100},13 \\
59  & Neutral beam shine-through fraction upper limit (NBI)     & L    & \textbf{105},6,19,4 \\
60  & Central solenoid temperature margin lower limit (SCTF)    & L    & \textbf{106}, \\
\hline
\end{tabular}
\end{center}
\caption[List of constraint equations 51 onwards]
{\label{tab:eqns2}
  \textit{Summary of constraint equations 51--60 present in \process. Consistency
    equations are marked C, limit equations are marked L\@. Some
    (non-exhaustive) iteration variable numbers (see Tables~\ref{tab:itvars1}
    and~\ref{tab:itvars2}) that directly affect the associated constraint
    equations are given, the one listed first being the most relevant.}
}
\normalsize
\end{table}

\section{Iteration Variables}
\label{sec:itvars}

It is necessary to calculate numerical derivatives during the solution of the
constraint equations. The iteration variables are the parameters that the
equation solvers use for this purpose --- all the other code variables (input
parameters --- see above) remain fixed at their initial value. Successive
calls are made to the physics and engineering routines, with slightly
different values for the iteration variables on each call, and the equation
solver determines the effect on the output due to these small changes to the
input (see Figures~\ref{fig:flow_hybrd} and \ref{fig:flow_vmcon}). The
\texttt{nvar} iteration variables that the user chooses for a given run are
activated by including the variable numbers in the first \texttt{nvar}
elements of array \texttt{ixc}. Tables~\ref{tab:itvars1} and~\ref{tab:itvars2}
list the iteration variables available in \process.

Clearly, the equation solvers need at least as many variables to iterate as
there are equations to solve, i.e.\ \texttt{nvar} $\geq$ \texttt{neqns}. If
the run is a non-optimising case, then \texttt{neqns} variables are iterated
--- the values of the remaining \texttt{(nvar-neqns)} variables are left
alone. If the run is an optimising case, then all the active iteration
variables are adjusted so as to find the minimum (or maximum) value of a
parameter (the \textit{ figure of merit}) in the \texttt{nvar}-dimensional
space of the problem.

All the iteration variables are constrained to lie between lower and upper
bounds, stored in arrays \texttt{boundl} and \texttt{boundu},
respectively. For instance, the plasma electron density is, by default,
confined to lie between the values $10^{19}$~m$^{-3}$ and
$10^{21}$~m$^{-3}$. Of course, it can also be constrained to lie below the
\textit{calculated}\/ density limit, if constraint equation 5 is activated and
the f-value \texttt{fdene} (iteration variable no.\ 9) is bounded by the
values 0 and 1.

It is important to remember that iteration variables \textit{must never be
initialised to zero}. The code will not be able to adjust the variable's value
if this is done, and it will stop with an error message.

% Tables summarising iteration variables

\begin{table}[tbph]
\footnotesize
\begin{center}

\begin{tabular}{||c|l|l|c|c|c||} \hline
\texttt{ixc} &          &                                               & \texttt{icc} & lower        & upper       \\
no. & variable name     & description                                   & eqn & bound        & bound       \\ \hline
1   & \texttt{aspect}   & plasma aspect ratio                           &     & \texttt{1.100D0} & \texttt{10.00D0} \\
2   & \texttt{bt}       & toroidal field on axis                        &     & \texttt{0.010D0} & \texttt{100.0D0} \\
3   & \texttt{rmajor}   & plasma major radius                           &     & \texttt{0.100D0} & \texttt{10.00D0} \\
4   & \texttt{te}       & electron temperature                          &     & \texttt{5.000D0} & \texttt{500.0D0} \\
5   & \texttt{beta}     & plasma beta                                   &     & \texttt{0.001D0} & \texttt{1.000D0} \\
6   & \texttt{dene}     & electron density                              &     & \texttt{1.00D19} & \texttt{1.00D21} \\
7   & \texttt{rnbeam}   & hot beam density / electron density           &     & \texttt{1.00D-6} & \texttt{1.000D0} \\
8   & \texttt{fbeta}    & f-value for $\epsilon.\beta_p$ limit equation & 6   & \texttt{0.001D0} & \texttt{1.000D0} \\
9   & \texttt{fdene}    & f-value for density limit equation            & 5   & \texttt{0.001D0} & \texttt{1.000D0} \\
10  & \texttt{hfact}    & confinement time $H$-factor                   &     & \texttt{0.100D0} & \texttt{3.000D0} \\
11  & \texttt{pheat}    & heating power not used for current drive      &     & \texttt{0.001D0} & \texttt{1.000D3} \\
12  & \texttt{oacdcp}   & overall current density in TF coil inboard leg&     & \texttt{1.000D5} & \texttt{1.500D8} \\
13  & \texttt{tfcth}    & TF coil inboard leg thickness                 &     & \texttt{1.000D0} & \texttt{5.000D0} \\
14  & \texttt{fwalld}   & f-value for wall load limit equation          & 8   & \texttt{0.001D0} & \texttt{1.000D0} \\
15  & \texttt{fvs}      & f-value for volt second limit equation        & 12  & \texttt{0.001D0} & \texttt{1.000D0} \\
16  & \texttt{ohcth}    & central solenoid thickness                    &     & \texttt{0.001D0} & \texttt{1.000D2} \\
17  & \texttt{tdwell}   & dwell time                                    &     & \texttt{0.100D0} & \texttt{1.000D8} \\
18  & \texttt{q}        & edge safety factor                            &     & \texttt{2.000D0} & \texttt{100.0D0} \\
19  & \texttt{enbeam}   & neutral beam energy                           &     & \texttt{1.000D0} & \texttt{1.000D6} \\
20  & \texttt{tcpav}    & average (resistive) TF coil temperature       &     & \texttt{40.00D0} & \texttt{1.000D3} \\
21  & \texttt{ftburn}   & f-value for burn time limit equation          & 13  & \texttt{0.001D0} & \texttt{1.000D0} \\
22  & \texttt{tbrnmn}   & minimum burn time                             &     & \texttt{0.001D0} & \texttt{1.000D6} \\
23  & \texttt{fcoolcp}  & coolant fraction of resistive TF coil         &     & \texttt{0.100D0} & \texttt{0.500D0} \\
24  & \texttt{cdtfleg}  & TF coil leg overall current density           &     & \texttt{1.000D4} & \texttt{1.000D8} \\
25  & \texttt{fpnetel}  & f-value for net electric power limit equation & 16  & \texttt{0.001D0} & \texttt{1.000D0} \\
26  & \texttt{ffuspow}  & f-value for fusion power limit equation       & 9   & \texttt{0.001D0} & \texttt{1.000D0} \\
27  & \texttt{fhldiv}   & f-value for divertor heat load limit equation & 18  & \texttt{0.001D0} & \texttt{1.000D0} \\
28  & \texttt{fradpwr}  & f-value for radiation power limit equation    & 17  & \texttt{0.001D0} & \texttt{1.000D0} \\
29  & \texttt{bore}     & machine bore                                  &     & \texttt{0.100D0} & \texttt{10.00D0} \\
30  & \texttt{fmva}     & f-value for MVA limit equation                & 19  & \texttt{0.010D0} & \texttt{1.000D0} \\
31  & \texttt{gapomin}  & minimum gap between outboard vacuum vessel and TF coil &     & \texttt{0.001D0} & \texttt{10.00D0} \\
32  & \texttt{frminor}  & f-value for minor radius limit equation       & 21  & \texttt{0.001D0} & \texttt{1.000D0} \\
33  & \texttt{fportsz}  & f-value for beam tangency radius limit equation & 20  & \texttt{0.001D0} & \texttt{1.000D0} \\
34  & \texttt{fdivcol}  & f-value for divertor collisionality limit equation & 22  & \texttt{0.001D0} & \texttt{1.000D0} \\
35  & \texttt{fpeakb}   & f-value for peak toroidal field limit equation & 25  & \texttt{0.001D0} & \texttt{1.000D0} \\
36  & \texttt{fbetatry} & f-value for beta limit equation               & 24  & \texttt{0.001D0} & \texttt{1.000D0} \\
37  & \texttt{coheof}   & central solenoid current density at end of flat-top &     & \texttt{1.000D5} & \texttt{1.000D8} \\
38  & \texttt{fjohc}    & f-value for central solenoid current at EOF limit equation & 26  & \texttt{0.010D0} & \texttt{1.000D0} \\
39  & \texttt{fjohc0}   & f-value for central solenoid current at BOP limit equation & 27  & \texttt{0.001D0} & \texttt{1.000D0} \\
40  & \texttt{fgamcd}   & f-value for current drive gamma limit equation & 37  & \texttt{0.001D0} & \texttt{1.000D0} \\
41  & \texttt{fcohbop}  & central solenoid current density ratio BOP/EOF &     & \texttt{0.001D0} & \texttt{1.000D0} \\
42  & \texttt{gapoh}    & gap between central solenoid and TF coil      &     & \texttt{0.001D0} & \texttt{10.00D0} \\
43  & \texttt{cfe0}     & seeded high-Z impurity fraction               &     & \texttt{1.00D-6} & \texttt{3.00D-3} \\
44  & \texttt{fvsbrnni} & fraction of plasma current produced by non-inductive means &     & \texttt{0.001D0} & \texttt{1.000D0} \\
45  & \texttt{fqval}    & f-value for fusion gain limit equation        & 28  & \texttt{0.001D0} & \texttt{1.000D0} \\
46  & \texttt{fpinj}    & f-value for injection power limit equation    & 30  & \texttt{0.001D0} & \texttt{1.000D0} \\
47  & \texttt{feffcd}   & current drive efficiency multiplier           &     & \texttt{0.001D0} & \texttt{1.000D0} \\
48  & \texttt{fstrcase} & f-value for TF coil case stress limit equation & 31  & \texttt{0.001D0} & \texttt{1.000D0} \\
49  & \texttt{fstrcond} & f-value for TF coil conduit stress limit equation & 32  & \texttt{0.001D0} & \texttt{1.000D0} \\
50  & \texttt{fiooic}   & f-value for TF coil operational current limit equation & 33  & \texttt{0.001D0} & \texttt{1.000D0} \\
51  & \texttt{fvdump}   & f-value for TF coil dump voltage limit equation         & 34  & \texttt{0.001D0} & \texttt{1.000D0} \\
52  & \texttt{vdalw}    & allowable TF coil dump voltage                          &     & \texttt{0.001D0} & \texttt{1.000D6} \\
53  & \texttt{fjprot}   & f-value for TF coil current protection limit equation   & 35  & \texttt{0.001D0} & \texttt{1.000D0} \\
54  & \texttt{ftmargtf} & f-value for TF coil temperature margin limit equation   & 36  & \texttt{0.001D0} & \texttt{1.000D0} \\
55  & \texttt{tmargmin} & minimum allowable TF/CS coil temperature margin          &     & \texttt{0.001D0} & \texttt{100.0D0} \\
\hline
\end{tabular}
\end{center}
\caption[List of iteration variables 1 to 55]
{\label{tab:itvars1}
  \textit{Iteration variables 1 to 55 present in \process. The f-values correspond to the
    given constraint equations (see Table~\ref{tab:eqns}). The other iteration
    variables are shown in Table~\ref{tab:itvars2}.}
}
\end{table}
\normalsize

\begin{table}[tbph]
\footnotesize
\begin{center}

\begin{tabular}{||c|l|l|c|c|c||} \hline
\texttt{ixc} &           &                                                         & \texttt{icc} & lower        & upper       \\
no. & variable name     & description                                             & eqn & bound        & bound       \\ \hline
56  & \texttt{tdmptf}   & dump time for TF coil                                   &     & \texttt{10.00D0} & \texttt{1.000D6} \\
57  & \texttt{thkcas}   & TF coil external case thickness                         &     & \texttt{0.050D0} & \texttt{1.000D0} \\
58  & \texttt{thwcndut} & TF coil conduit case thickness                          &     & \texttt{0.001D0} & \texttt{1.000D0} \\
59  & \texttt{fcutfsu}  & copper fraction of cable conductor                      &     & \texttt{0.001D0} & \texttt{1.000D0} \\
60  & \texttt{cpttf}    & current per turn in the TF coils                        &     & \texttt{0.001D0} & \texttt{4.000D4} \\
61  & \texttt{gapds}    & gap between vacuum vessel and inboard TF coil           &     & \texttt{0.001D0} & \texttt{10.00D0} \\
62  & \texttt{fdtmp}    & f-value for 1st wall coolant temperature rise limit equation & 38  & \texttt{0.001D0} & \texttt{1.000D0} \\
63  & \texttt{ftpeak}   & f-value for 1st wall peak temperature limit equation    & 39  & \texttt{0.001D0} & \texttt{1.000D0} \\
64  & \texttt{fauxmn}   & f-value for minimum auxiliary power limit equation      & 40  & \texttt{0.001D0} & \texttt{1.000D0} \\
65  & \texttt{tohs}     & central solenoid current ramp-up time                   &     & \texttt{0.100D0} & \texttt{1.000D3} \\
66  & \texttt{ftohs}    & f-value for central solenoid current ramp-up time limit equation & 41  & \texttt{0.001D0} & \texttt{1.000D0} \\
67  & \texttt{ftcycl}   & f-value for minimum cycle time limit equation           & 42  & \texttt{0.001D0} & \texttt{1.000D0} \\
68  & \texttt{fptemp}   & f-value for maximum centrepost temperature limit equation & 44  & \texttt{0.001D0} & \texttt{1.000D0} \\
69  & \texttt{rcool}    & average radius of centrepost coolant channel            &     & \texttt{0.001D0} & \texttt{0.010D0} \\
70  & \texttt{vcool}    & maximum centrepost coolant flow speed at midplane       &     & \texttt{1.000D0} & \texttt{1.000D2} \\
71  & \texttt{fq}       & f-value for minimum edge safety factor limit equation   & 45  & \texttt{0.001D0} & \texttt{1.000D0} \\
72  & \texttt{fipir}    & f-value for maximum $I_p/I_{rod}$ limit equation         & 46  & \texttt{0.001D0} & \texttt{1.000D0} \\
73  & \texttt{scrapli}  & inboard gap between plasma and first wall               &     & \texttt{0.001D0} & \texttt{10.00D0} \\
74  & \texttt{scraplo}  & outboard gap between plasma and first wall              &     & \texttt{0.001D0} & \texttt{10.00D0} \\
75  & \texttt{tfootfi}  & ratio of TF coil outboard/inboard leg thickness         &     & \texttt{0.200D0} & \texttt{5.000D0} \\
76  & \texttt{frfptf}   & f-value for TF coil toroidal thickness limit equation   & 47  & \texttt{0.001D0} & \texttt{1.000D0} \\
77  & \texttt{tftort}   & TF coil toroidal thickness (use for RFPs only)          &     & \texttt{0.050D0} & \texttt{4.000D0} \\
78  & \texttt{rfpth}    & RFP pinch parameter, $\Theta$                           &     & \texttt{0.010D0} & \texttt{1.800D0} \\
79  & \texttt{fbetap}   & f-value for poloidal beta limit equation                & 48  & \texttt{0.001D0} & \texttt{1.000D0} \\
80  & \texttt{frfpf}    & f-value for RFP reversal parameter limit equation       & 49  & \texttt{0.001D0} & \texttt{1.000D0} \\
81  & \texttt{edrive}   & IFE driver energy                                       &     & \texttt{1.000D5} & \texttt{5.000D7} \\
82  & \texttt{drveff}   & IFE driver wall plug to target efficiency               &     & \texttt{0.010D0} & \texttt{1.000D0} \\
83  & \texttt{tgain}    & IFE target gain                                         &     & \texttt{1.000D0} & \texttt{500.0D0} \\
84  & \texttt{chrad}    & radius of IFE chamber                                   &     & \texttt{0.100D0} & \texttt{20.00D0} \\
85  & \texttt{pdrive}   & IFE driver power reaching target                        &     & \texttt{1.000D6} & \texttt{2.000D8} \\
86  & \texttt{frrmax}   & f-value for maximum IFE repetition rate equation        & 50  & \texttt{0.001D0} & \texttt{1.000D0} \\
87  & \texttt{helecmw}  & electrical power required for hydrogen production       &     & \texttt{1.000D0} & \texttt{4.000D3} \\
88  & \texttt{hthermmw} & thermal power required for hydrogen production          &     & \texttt{1.000D0} & \texttt{4.000D3} \\
89  & \texttt{ftbr}     & f-value for tritium breeding ratio limit equation       & 52  & \texttt{0.001D0} & \texttt{1.000D0} \\
90  & \texttt{blbuith}  & inboard blanket breeding unit thickness                 &     & \texttt{0.001D0} & \texttt{2.000D0} \\
91  & \texttt{blbuoth}  & outboard blanket breeding unit thickness                &     & \texttt{0.001D0} & \texttt{2.000D0} \\
92  & \texttt{fflutf}   & f-value for fast neutron fluence on TF coil equation    & 53  & \texttt{0.001D0} & \texttt{1.000D0} \\
93  & \texttt{shldith}  & inboard shield thickness                                &     & \texttt{0.001D0} & \texttt{10.00D0} \\
94  & \texttt{shldoth}  & outboard shield thickness                               &     & \texttt{0.001D0} & \texttt{10.00D0} \\
95  & \texttt{fptfnuc}  & f-value for TF coil nuclear heating limit equation      & 54  & \texttt{0.001D0} & \texttt{1.000D0} \\
96  & \texttt{fvvhe}    & f-value for vessel He concentration limit equation      & 55  & \texttt{0.001D0} & \texttt{1.000D0} \\
97  & \texttt{fpsepr}   & f-value for $P_{\mbox{\scriptsize separatrix}}/R_{\mbox{\scriptsize major}}$ limit equation & 56
  & \texttt{0.001D0} & \texttt{1.000D0} \\
98  & \texttt{li6enrich}& lithium-6 enrichment percentage (\texttt{blktmodel=1})  &     & \texttt{0.001D0} & \texttt{100.0D0} \\
99  & \texttt{ftftort}  & (OBSOLETE) f-value for TF coil toroidal thickness lower limit eqn  & 57  & \texttt{0.001D0} & \texttt{1.000D0} \\
100 & \texttt{ftfthko}  & (OBSOLETE) f-value for TF coil radial thickness lower limit eqn    & 58  & \texttt{0.001D0} & \texttt{1.000D0} \\
101 & \texttt{prp}      & ratio of TF coil radial plate area to winding pack area &     & \texttt{1.00D-6} & \texttt{0.010D0} \\
102 & \texttt{fimpvar}  & impurity fraction of element \texttt{impvar}            &     & \texttt{1.00D-6} & \texttt{0.010D0} \\
103 & \texttt{flhthresh}& f-value for L-H power threshold limit equation          & 15  & \texttt{1.000D0} & \texttt{1.000D6} \\
104 & \texttt{fcwr}     & f-value for conducting shell radius limit equation      & 23  & \texttt{0.001D0} & \texttt{1.000D0} \\
105 & \texttt{fnbshinef}& f-value for NBI shine-through fraction limit equation   & 59  & \texttt{0.001D0} & \texttt{1.000D0} \\
106 & \texttt{ftmargoh} & f-value for CS coil temperature margin limit equation   & 60  & \texttt{0.001D0} & \texttt{1.000D0} \\
\hline
\end{tabular}
\end{center}
\caption[List of iteration variables 56 to 106]
{\label{tab:itvars2}
  \textit{Iteration variables 56 to 106 present in \process. The f-values correspond to the
    given constraint equations (see Table~\ref{tab:eqns}). The other iteration
    variables are shown in Table~\ref{tab:itvars1}.}
}
\end{table}
\normalsize


\section{Figures of Merit}
\label{sec:foms}

In optimisation mode, \process\ finds the self-consistent set of iteration
variable values that maximises or minimises a certain function of them, known
as the \textit{figure of merit}. Several possible figures of merit are
available, all of which are formulated in routine \texttt{FUNFOM} in source
file \texttt{evaluators.f90}.  Switch \texttt{minmax} is used to control which
figure of merit is to be used, as summarised in Table~\ref{tab:foms}. If the
figure of merit is to be minimised, \texttt{minmax} should be positive, and if
a maximised figure of merit is desired, \texttt{minmax} should be negative.

% Table summarising figures of merit

\begin{table}[tbph]
\begin{center}

\begin{tabular}{||c|l||} \hline
\texttt{minmax} & description \\ \hline
$\pm 1 $        & plasma major radius \\
$\pm 2 $        & ratio of fusion power to input power \\
$\pm 3 $        & neutron wall load \\
$\pm 4 $        & total TF coil + PF coil power \\
$\pm 5 $        & ratio of fusion power to injection power \\
$\pm 6 $        & cost of electricity \\
$\pm 7 $        & 
$ \left\{ \begin{array}{ll}
 \mbox{direct cost} & \mbox{if \texttt{ireactor = 0}} \\
 \mbox{constructed cost} & \mbox{otherwise}
\end{array} \right. $ \\
$\pm 8 $        & aspect ratio \\
$\pm 9 $        & divertor heat load \\
$\pm 10$        & toroidal field on axis \\
$\pm 11$        & injection power \\
$\pm 12$        & hydrogen plant capital cost \\
$\pm 13$        & hydrogen production rate \\
$\pm 14$        & pulse length \\
$\pm 15$        & plant availability factor (N.B.\ requires \texttt{iavail=1}) \\
\hline
\end{tabular}
\end{center}
\caption[List of figures of merit]
{\label{tab:foms}
  \textit{Summary of the available figures of merit in \process. If the figure
    of merit is to be minimised, \texttt{minmax} should be positive, and if a maximised
    figure of merit is desired, \texttt{minmax} should be negative.}
}
\end{table}

\section{Scanning Variables}
\label{sec:scans}

One of a number of variables can be scanned during the course of a \process\
run.  This option provides a method of determining the sensitivity of the
results to different input assumptions. The user specifies which variable is
to be scanned (see Table~\ref{tab:scans}) and its required value at each point
in the scan. The scanned variable to use is defined by the value of
\texttt{nsweep}, and the chosen variable's values during the scan are set in
array \texttt{sweep}.

Runs involving scans of this kind can only be performed in optimisation mode.
The results from the previous scan point are used as the input to the next
scan point. Routine \texttt{SCAN} in source file \texttt{scan.f90} stores many
of the output quantities in a separate output file called \plotdat, which can
be read by the utility program \texttt{plot\_sweep} to produce graphical
output (see Chapter~\ref{chap:utilities}).

Scanning of derived quantities requires use of the appropriate constraint
equations. For instance, if the net electric power is scanned, constraint
equation~16 should be employed.

For obvious reasons, the active scanning variable must not also be an active
iteration variable.

% Table summarising scanning variables

\begin{table}[tbph]
\begin{center}

\begin{tabular}{||c|l|l||} \hline
\texttt{nsweep} & scan variable & description \\ \hline
$1 $ & \texttt{aspect}     & plasma aspect ratio \\
$2 $ & \texttt{hldivlim}   & maximum divertor heat load \\
$3 $ & \texttt{pnetelin}   & required net electric power \\
$4 $ & \texttt{hfact}      & confinement time $H$-factor \\
$5 $ & \texttt{oacdcp}     & overall current density in TF coil inboard leg \\
$6 $ & \texttt{walalw}     & allowable wall load \\
$7 $ & \texttt{beamfus0}   & beam-background fusion multiplier \\
$8 $ & \texttt{fqval}      & f-value for fusion gain limit eqn \\
$9 $ & \texttt{te}         & electron temperature \\
$10$ & \texttt{boundu(15)} & upper bound on f-value \texttt{fvs} \\
$11$ & \texttt{dnbeta}     & beta $g$ coefficient \\
$12$ & \texttt{bscfmax}    & bootstrap current fraction (use negative values) \\
$13$ & \texttt{boundu(10)} & upper bound on confinement time H-factor \texttt{hfact}\\
$14$ & \texttt{fiooic}     & f-value for TF coil operational current limit eqn \\
$15$ & \texttt{fjprot}     & f-value for TF coil current protection limit eqn \\
$16$ & \texttt{rmajor}     & plasma major radius \\
$17$ & \texttt{bmxlim}     & maximum toroidal field \\
$18$ & \texttt{gammax}     & maximum current drive gamma \\
$19$ & \texttt{boundl(16)} & lower bound on central solenoid thickness \texttt{ohcth} \\
$20$ & \texttt{tbrnmn}     & minimum burn time (pulsed operation machine) \\
$21$ & \texttt{sigpfalw}   & allowable stress in the PF coils \\
$22$ & \texttt{cfactr}     & plant availability factor (N.B.\ requires
\texttt{iavail=0}) \\
$23$ & \texttt{boundu(72)} & upper bound on f-value \texttt{fipir} \\
$24$ & \texttt{powfmax}    & maximum fusion power \\
$25$ & \texttt{kappa}      & plasma elongation \\
$26$ & \texttt{triang}     & plasma triangularity \\
$27$ & \texttt{tbrmin}     & minimum tritium breeding ratio (\texttt{blktmodel=1}) \\
$28$ & \texttt{bt}         & toroidal field on axis \\
$29$ & \texttt{coreradius} & normalised radius defining the core region \\
$30$ & \texttt{fimpvar}    & impurity fraction of element \texttt{impvar} \\
\hline
\end{tabular}
\end{center}
\caption[List of scanning variables]
{\label{tab:scans}
  \textit{Summary of the scanning variables available in \process.}
}
\end{table}

\section{Code Structure}

The structure of the majority of the code reflects to a certain extent the
layout of the machine being modelled. As stated above, a large proportion of
the code is simply a description of the underlying physics and engineering
issues in terms of numerous expressions and relationships. In effect these
define the machine so that the numerical solver within the code can then get
to work adjusting the parameters in its search for a self-consistent solution.

It is essential for a program of the size and complexity of \process\ to be
modular to a high degree, in order to simplify the tasks of understanding and
maintaining the code. The use of Fortran~90/95 modules provides a natural and
convenient way for this to be done. The following sections describe briefly
the modules into which \process\ is divided.

\subsection{Numerics modules}
\label{sec:numerics_modules}

These modules contain the equation solvers, their calling routines and other
relevant procedures. Various mathematical routines from a number of standard
libraries are also incorporated into these files. Table~\ref{tab:numerics}
summarises the numerics source file contents.
% Link to concepts, i.e. constraints, iteration variables etc.

% Table summarising numerics modules in PROCESS
\begin{table}[tbph]
\footnotesize
\begin{center}
\begin{tabular}{||l||l||} \hline
source file   & description \\ \hline
\texttt{caller.f90} & calls physics and engineering routines \\
\texttt{constraint\_equations.f90} & defines the constraint equations \\
\texttt{evaluators.f90} & function evaluators for HYBRD and VMCON packages \\
\texttt{iteration\_variables.f90} & adjusts values of iteration variables \\
\texttt{maths\_library.f90} & miscellaneous `black-box' maths routines,
including HYBRD and VMCON \\
\texttt{numerics.f90} & numerics array definitions, and calling routines for
HYBRD and VMCON packages \\
\texttt{scan.f90} & performs a parameter scan \\
\hline
\end{tabular}
\end{center}
\caption[Summary of numerics modules]
{\label{tab:numerics}
  \textit{Summary of the numerics modules in \process.}
}
\end{table}

\subsection{Physics modules}

These modules contain the main physics routines that evaluate the plasma and
fusion parameters. Also included here are the routines describing the current
drive and divertor systems. Table~\ref{tab:physics} summarises the physics
source file contents.

% Table summarising physics modules in PROCESS
\begin{table}[tbph]
\begin{center}

\begin{tabular}{||l||l||} \hline
source file   & description \\ \hline
\texttt{current\_drive.f90} & current drive efficiency calculations \\
\texttt{divertor.f90} & divertor model calculations\\
\texttt{fispact.f90} & nuclide inventory/activation calculations \\
\texttt{ife.f90} & inertial fusion energy physics/engineering \\
\texttt{impurity\_radiation.f90} & radiation power calculations \\
\texttt{physics.f90} & tokamak plasma and fusion calculations \\
\texttt{plasma\_geometry.f90} & plasma geometry algorithms \\
\texttt{plasma\_profiles.f90} & plasma density and temperature profile calculations \\
\texttt{rfp.f90} & reversed field pinch physics/engineering \\
\texttt{startup.f90} & plasma start-up auxiliary power requirements \\
\texttt{stellarator.f90 } & stellarator-relevant physics/engineering \\
\hline
\end{tabular}
\end{center}
\caption[Summary of physics modules]
{\label{tab:physics}
  \textit{Summary of the physics modules in \process.}
}
\end{table}

\subsection{Engineering modules}

These modules contain the description of the machine geometry and its major
systems, including the PF and TF coil sets, the first wall, blanket and
shield, and other items such as the buildings, vacuum system, power conversion
and the structural components.  Table~\ref{tab:engineering} summarises the
engineering source file contents.

% Table summarising engineering modules in PROCESS
\begin{table}[tbph]
\begin{center}

\begin{tabular}{||l||l||} \hline
source file     & description \\ \hline
\texttt{availability.f90} & plant component lifetimes and overall availability \\
\texttt{buildings.f90} & buildings calculations \\
\texttt{fwbs.f90} & first wall, blanket and shield calculations \\
\texttt{machine\_build.f90} & machine build calculations \\
\texttt{pfcoil.f90} & PF coil calculations \\
\texttt{plant\_power.f90} & heat transport and power balance calculations \\
\texttt{pulse.f90} & pulsed power plant calculations \\
\texttt{safety.f90} & steady-state temperatures after a LOCA event \\
\texttt{sctfcoil.f90} & superconducting TF coil calculations \\
\texttt{structure.f90} & support structure calculations \\
\texttt{tfcoil.f90} & resistive TF coil calculations \\
\texttt{vacuum.f90} & vacuum system calculations \\
\hline
\end{tabular}
\end{center}
\caption[Summary of engineering modules]
{\label{tab:engineering}
  \textit{Summary of the engineering modules in \process.}
}
\end{table}

\subsection{Costing module}

The costing module, \texttt{costs.f90}, performs all the cost calculations,
including values in M\$ for each machine system, and the cost of electricity
in m\$/kWh. Normally, the machine costs are written to the output file; if
this is not required set switch \texttt{output\_costs = 0}.

\subsection{Other modules}

These modules perform miscellaneous tasks, such as initialisation of variables
and file input / output. File \texttt{process.f90} contains the main program,
and includes the overall controlling loop.

Table~\ref{tab:other_modules} summarises these modules.

% Table summarising miscellaneous modules in PROCESS
\begin{table}[tbph]
\begin{center}

\begin{tabular}{||l||l||} \hline
source file     & description \\ \hline
\texttt{error\_handling.f90} & centralised error handling module \\
\texttt{fson\_library.f90} & library used to read in data from JSON-format files \\
\texttt{global\_variables.f90} & defines and initialises most shared variables \\
\texttt{initial.f90} & checks self-consistency of input variables and switches \\
\texttt{input.f90} & reads in user-defined settings from input file \\
\texttt{output.f90} & utility routines to format output to file \\
\texttt{process.f90} & main program and top-level calling routines \\
\hline
\end{tabular}
\end{center}
\caption[Summary of other modules]
{\label{tab:other_modules}
  \textit{Summary of the remaining modules in \process.}
}
\end{table}

