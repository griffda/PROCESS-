#
#  GitLab CI configuration file for PROCESS repository
#
#  J. Morris
#  M. Kumar
#
#  UKAEA
#  29/07/19
#
#-----------------------------------------------------

stages:
  - build
  - testing
  - baseline
  - standards
  - freia
  - pages

.before_script_template: &build-freia-setup
  before_script:
    - export LOGNAME=root
    - source /etc/profile.d/modules.sh
    - module use /usr/local/modules/default
    - module unload python
    - module load python/3.5.1
    - module load texlive/2017
    - module unload ifort 
    - module load gfortran
    - export GTEST=/home/PROCESS/testing_frameworks/googletest/googletest
    - echo ld_library_path=$LD_LIBRARY_PATH
    # Modify PATH so "ford" command can be found in cmake file
    - export PATH=$PATH:~/.local/bin
    # Python3 uses the locale to choose the file encoding it uses
    # Without this it will use ASCII encoding and Ford will fail
    - export LANG=en_GB.utf8

.before_script_template: &build-ubuntu-setup
  before_script:
    # Modify PATH so "ford" command can be found in cmake file
    - export PATH=$PATH:~/.local/bin
    - export LANG=C.UTF-8
    - pwd
    - gcc --version
    - ls -lah
    - cmake -H. -Bbuild

# Build stage 
#------------

make:
  only:
    - develop
    - /^issue-.*$/
  stage: build
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build


make_dicts:
  only:
    - develop
    - /^issue-.*$/
  stage: build
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build --target dicts


make_developerguide:
 only:
  - develop
  - /^issue-.*$/
 stage: build
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - cmake --build build --target developerguide


make_utilitiesdoc:
 only:
  - develop
  - /^issue-.*$/
 stage: build
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - cmake --build build --target utilitiesdoc


make_optsolverdoc:
 only:
  - develop
  - /^issue-.*$/
 stage: build
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - cmake --build build --target optsolverdoc


make_tfdoc:
 only:
  - develop
  - /^issue-.*$/
 stage: build
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - cmake --build build --target tfdoc

# Testing stage 
#--------------

unit_tests:
 when: on_success
 only:
  - develop
  - /^issue-.*$/
 stage: testing
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - cmake --build build
  - ls bin/
  - ./bin/process_GTest.exe


test_suite:
  when: on_success
  only:
    - develop
    - /^issue-.*$/
  stage: testing
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build
    - cmake --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd test_suite
    - python3 test_suite.py 


baseline_2019_run:
  when: on_success
  only:
    - develop
    - /^issue-.*$/
  stage: testing
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build
    - cd tracking/baseline_2019
    - ./../../bin/process.exe baseline_2019_IN.DAT


baseline_2018_run:
  when: on_success
  only:
    - develop
    - /^issue-.*$/
  stage: testing
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build
    - cd tracking/baseline_2018
    - ./../../bin/process.exe baseline_2018_IN.DAT


# Baseline stage 
#---------------

baseline_2019_results:
  when: on_success
  only:
    - develop
    - /^issue-.*$/
  stage: baseline
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build
    - cmake --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd tracking/baseline_2019
    - ./../../bin/process.exe baseline_2019_IN.DAT
    - > 
      python3 ../../utilities/mfile_comparison.py 
      -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
      --acc 1.0 
      --baseline
    - > 
      python3 ../../utilities/mfile_comparison.py 
      -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
      --acc 10.0 
      --baseline


# Check the baseline 2018 test results for discrepancies at:
#   -  1% 
#   - 10%
baseline_2018_results:
  when: on_success
  only:
    - develop
    - /^issue-.*$/
  stage: baseline
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - cmake --build build
    - cmake --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd tracking/baseline_2018
    - ./../../bin/process.exe baseline_2018_IN.DAT
    - >
      python3 ../../utilities/mfile_comparison.py 
      -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
      --acc 1.0 
      --baseline
    - > 
      python3 ../../utilities/mfile_comparison.py 
      -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
      --acc 10.0 
      --baseline


# Standards stage 
#----------------

line_length:
 when: on_success
 only:
  - develop
  - /^issue-.*$/
 stage: standards
 <<: *build-ubuntu-setup
 image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
 script:
  - pwd
  - python3 utilities/line_length_standard.py

# Freia
#------

make_freia:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - rm -rf build
    - cmake3 -H. -Bbuild
    - cmake3 --build build
    - ls bin -lah
    - echo "Test "
  artifacts:
    expire_in: 2 hrs
    paths:
      - bin/process.exe
      - bin/process_GTest.exe
      - bin/libPROCESS_calc_engine.so
  tags:
    - freia

make_dicts_freia:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target dicts
  tags:
    - freia

make_developerguide_freia:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target developerguide
  tags:
    - freia

make_utilitiesdoc_freia:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target utilitiesdoc
  tags:
    - freia

make_optsolverdoc_friea:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target optsolverdoc
  tags:
    - freia

make_tfdoc_freia:
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target tfdoc
  tags:
    - freia

unit_tests_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - rm -rf build
    - cmake3 -H. -Bbuild
    - cmake3 --build build
    - ls bin/
    - ./bin/process_GTest.exe
  tags:
    - freia

test_suite_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - cmake3 -H. -Bbuild
    - cmake3 --build build
    - cmake3 --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd test_suite
    - python test_suite.py
  tags:
    - freia

baseline_2019_run_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - gcc --version
    - ls -lah
    - rm -rf build
    - cmake3 -H. -Bbuild
    - cmake3 --build build
    - cd tracking/baseline_2019
    - ./../../bin/process.exe baseline_2019_IN.DAT
  artifacts:
    expire_in: 2 hrs
    paths:
      - tracking/baseline_2019/baseline_2019_MFILE.DAT
  tags:
    - freia

baseline_2018_run_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - pwd
    - gcc --version
    - ls -lah
    - rm -rf build
    - cmake3 -H. -Bbuild
    - cmake3 --build build
    - cd tracking/baseline_2018
    - ./../../bin/process.exe baseline_2018_IN.DAT
  artifacts:
    expire_in: 2 hrs
    paths:
      - tracking/baseline_2018/baseline_2018_MFILE.DAT
  tags:
    - freia

baseline_2019_results_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd tracking/baseline_2019
    - > 
      python ../../utilities/mfile_comparison.py 
      -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
      --acc 1.0 
      --baseline
    - > 
      python ../../utilities/mfile_comparison.py 
      -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
      --acc 10.0 
      --baseline
  tags:
   - freia

baseline_2018_results_freia:
  when: on_success
  only:
    - develop
  stage: freia
  <<: *build-freia-setup
  script:
    - pwd
    - cmake3 -H. -Bbuild
    - cmake3 --build build --target dicts
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - cd tracking/baseline_2018
    - >
      python ../../utilities/mfile_comparison.py 
      -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
      --acc 1.0 
      --baseline
    - > 
      python ../../utilities/mfile_comparison.py 
      -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
      --acc 10.0 
      --baseline
  tags:
    - freia

# Pages
#------

pages:
  before_script:
    - "export LOGNAME=root"
    - export LANG=C.UTF-8
    # Python3 uses the locale to choose the file encoding it uses
    # Without this it will use ASCII encoding and Ford will fail
  when: on_success
  only:
    - develop
  stage: pages
  <<: *build-ubuntu-setup
  image: git.ccfe.ac.uk:4567/process/process/ci-image:latest
  script:
    - pwd
    - cmake -H. -Bbuild
    - mkdocs build
   
    # FORD documentation
    # Ensure FORD can find create_dicts.py inside Process
    - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
    - python3 lib/ford/ford.py documentation/ford/index.md

    # Publish the MkDocs and FORD sites
    - ls site
    - mv site public
    - mv ford_site public
    - ls public
  artifacts:
    paths:
    - public
