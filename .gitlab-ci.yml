#
#  GitLab CI configuration file for PROCESS repository
#
#  J. Morris
#  M. Kumar
#
#  UKAEA
#  29/07/19
#
#-----------------------------------------------------

stages:
  - build
  - testing
  - jenkins
  - baseline
  - standards
  - pages

before_script:
  - export LOGNAME=root
  - source /etc/profile.d/modules.sh
  - module use /usr/local/modules/default
  - module unload python
  - module load python/3.5.1
  - module load texlive/2017
  - module unload ifort 
  - module load gfortran
  - export GTEST=/home/PROCESS/testing_frameworks/googletest/googletest
  - echo ld_library_path=$LD_LIBRARY_PATH
  # Modify PATH so "ford" command can be found in cmake file
  - export PATH=$PATH:~/.local/bin
  # Python3 uses the locale to choose the file encoding it uses
  # Without this it will use ASCII encoding and Ford will fail
  - export LANG=en_GB.utf8

# Build stage 
#------------

make:
# image: ukaea/ubuntu
 only:
  - develop
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - rm -rf build
  - cmake3 -H. -Bbuild
  - cmake3 --build build
  # Trigger for PROCESS_Testing on GitLab CI develop is PROCESS_Testing branch
  - "curl -X POST -F token=24e840ea1977a3283dd1288732e5d0 -F ref=develop \
    https://git.ccfe.ac.uk/api/v4/projects/2172/trigger/pipeline"  
  - ls bin -lah
  - echo "Test "
 artifacts:
   expire_in: 2 hrs
   paths:
     - bin/process.exe
     - bin/process_GTest.exe
     - bin/libPROCESS_calc_engine.so
 tags:
  - freia

make_default:
 only:
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - rm -rf build
  - cmake3 -H. -Bbuild
  - cmake3 --build build
  - ls bin -lah
  - echo "Test "
 artifacts:
   expire_in: 2 hrs
   paths:
     - bin/process.exe
     - bin/process_GTest.exe
     - bin/libPROCESS_calc_engine.so
 tags:
  - freia

make_dicts:

 only:
  - develop
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target dicts
 tags:
  - freia

make_developerguide:

 only:
  - develop
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target developerguide
 tags:
  - freia

make_utilitiesdoc:

 only:
  - develop
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target utilitiesdoc
 tags:
  - freia

make_optsolverdoc:

 only:
  - develop
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target optsolverdoc
 tags:
  - freia

make_tfdoc:

 only:
  - develop
  - /^issue-.*$/
 stage: build
 script:
  - pwd
  - gcc --version
  - ls -lah
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target tfdoc
 tags:
  - freia

# Testing stage 
#--------------

unit_tests:
 when: on_success  # Also default setting
 only:
  - develop
  - /^issue-.*$/
 stage: testing
 script:
  - pwd
  - ls bin/
  - ./bin/process_GTest.exe
 tags:
  - freia

test_suite:
 when: on_success  # Also default setting
 only:
  - develop
 stage: testing
 script:
  - pwd
  # Now trigger testing on Jenkins
  - "curl -X POST http://mkumar:0eb1252f76a609d527edfbfdc0559eae@process-\
    jenkins-ci.apps.l:8080/jenkins/job/PROCESS/build?token=MiLNGc-QvyEevhKK54go"
 tags:
  - freia

test_suite_gitlab:
 when: on_success  # Also default setting
 only:
  - develop
  - /^issue-.*$/
 stage: testing
 script:
  - pwd
  - cmake3 -H. -Bbuild
  - cmake3 --build build
  - cmake3 --build build --target dicts
  - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
  - cd test_suite
  - python test_suite.py
 tags:
  - freia

baseline_2019_run:
 when: on_success  # Also default setting
 only:
  - develop
  - /^issue-.*$/
 stage: testing
 script:
  - pwd
  - cd tracking/baseline_2019
  - ./../../bin/process.exe baseline_2019_IN.DAT
 artifacts:
   expire_in: 2 hrs
   paths:
     - tracking/baseline_2019/baseline_2019_MFILE.DAT
 tags:
  - freia

baseline_2018_run:
 when: on_success  # Also default setting
 only:
  - develop
  - /^issue-.*$/
 stage: testing
 script:
  - pwd
  - cd tracking/baseline_2018
  - ./../../bin/process.exe baseline_2018_IN.DAT
 artifacts:
   expire_in: 2 hrs
   paths:
     - tracking/baseline_2018/baseline_2018_MFILE.DAT
 tags:
  - freia


# Baseline stage 
#---------------

baseline_tracking:
 when: on_success  # Also default setting
 only:
#  - merge_requests # Enable if Only merge request trigger tracking job
  - develop
 stage: baseline
 script: # Now trigger job in Jenkins
  - "curl -X POST http://mkumar:11e6783cdcc8e709d27e5376d2f57d8741@process-\
    jenkins-ci.apps.l:8080/jenkins/job/PROCESS_Tracking/build?token=MiLNGc-\
    QvyEevhKK54go"
 tags:
  - freia

baseline_2019_results:
 when: on_success  # Also default setting
 only:
  - develop
  - /^issue-.*$/
 stage: baseline
 script:
  - pwd
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target dicts
  - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
  - cd tracking/baseline_2019
  - > 
    python ../../utilities/mfile_comparison.py 
    -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
    --acc 1.0 
    --baseline
  - > 
    python ../../utilities/mfile_comparison.py 
    -f baseline_2019_MFILE.DAT ref_baseline_2019_MFILE.DAT 
    --acc 10.0 
    --baseline
 tags:
  - freia

# Check the baseline 2018 test results for discrepancies at:
#   -  1% 
#   - 10%
baseline_2018_results:
 when: on_success
 only:
  - develop
  - /^issue-.*$/
 stage: baseline
 script:
  - pwd
  - cmake3 -H. -Bbuild
  - cmake3 --build build --target dicts
  - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
  - cd tracking/baseline_2018
  - >
    python ../../utilities/mfile_comparison.py 
    -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
    --acc 1.0 
    --baseline
  - > 
    python ../../utilities/mfile_comparison.py 
    -f baseline_2018_MFILE.DAT ref_baseline_2018_MFILE.DAT 
    --acc 10.0 
    --baseline
 tags:
  - freia


# Standards stage 
#----------------

line_length:
 when: on_success
 only:
  - develop
  - /^issue-.*$/
 stage: standards
 script:
  - pwd
  - python utilities/line_length_standard.py
 tags:
  - freia

# Pages
#------

pages:
  before_script:
    - "export LOGNAME=root"
    - export LANG=C.UTF-8
    # Python3 uses the locale to choose the file encoding it uses
    # Without this it will use ASCII encoding and Ford will fail
  when: on_success
  only:
    - develop
    - issue-951-ford_var_des
  stage: pages
  script:
   - pwd
   - apt-get update
   - apt-get install -y python-dev python-pip pandoc cmake gcc gfortran graphviz
   - apt-get install -y python3-pip
   - pip install mkdocs
   - pip install mkdocs-material
   - pip install pymdown-extensions
   - cmake -H. -Bbuild
   - mkdocs build
   
   # FORD documentation
   # Ensure FORD can find create_dicts.py inside Process
   - export PYTHONPATH=$PYTHONPATH:/builds/process/process/utilities/
   - cd ..
   - rm -rf ford # Need to clone to empty dir
   - git clone https://github.com/jonMaddockUkaea/ford.git ford
   - cd ford
   - pip3 install .
   - cd ../process
   - ford documentation/ford/index.md

   # Publish the MkDocs and FORD sites
   - ls site
   - mv site public
   - mv ford_site public
   - ls public
  artifacts:
    paths:
    - public

# Old bits
#---------

# This command is used for generating gtest results in Jenkins  
# ./bin/process_test.exe --gtest_output=xml:gtest_results.xml

#after_script:  # Now trigger testing
#- "curl -X POST -F token=24e840ea1977a3283dd1288732e5d0 -F ref=develop 
# https://git.ccfe.ac.uk/api/v4/projects/2172/trigger/pipeline"